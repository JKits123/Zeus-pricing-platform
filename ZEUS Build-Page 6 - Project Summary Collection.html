<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZEUS - Project Collection Summary</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5f0 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 4px solid #00B04F;
        }

        .header {
            background: linear-gradient(135deg, #00B04F 0%, #009944 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .company-logo {
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .logo {
            font-size: 42px;
            font-weight: bold;
            color: white;
            letter-spacing: 3px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.95;
            margin-top: 5px;
            color: #f0f8ff;
        }

        .status-indicator {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .project-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #00B04F;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .project-info {
            text-align: center;
        }

        .project-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .project-value {
            font-size: 18px;
            font-weight: bold;
            color: #00B04F;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .section-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .section-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-card:hover {
            border-color: #00B04F;
            box-shadow: 0 4px 15px rgba(0, 176, 79, 0.1);
        }

        .section-header {
            background: linear-gradient(135deg, #00B04F 0%, #009944 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
        }

        .edit-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .section-body {
            padding: 20px;
        }

        .cost-breakdown {
            display: grid;
            gap: 12px;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
        }

        .cost-row.cost {
            background: #ffebee;
            color: #e74c3c;
        }

        .cost-row.profit {
            background: #e3f2fd;
            color: #3498db;
        }

        .cost-row.sale {
            background: #e8f5e8;
            color: #27ae60;
            border: 2px solid #27ae60;
        }

        .summary-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 3px solid #00B04F;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .summary-title {
            font-size: 24px;
            font-weight: bold;
            color: #00B04F;
            text-align: center;
            margin-bottom: 25px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .summary-breakdown {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }

        .summary-breakdown h4 {
            color: #00B04F;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 16px;
        }

        .controls-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }

        .controls-section h4 {
            color: #00B04F;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .control-input {
            width: 120px;
            padding: 10px;
            border: 2px solid #00B04F;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }

        .control-input.percentage {
            color: #3498db;
        }

        .control-input.currency {
            color: #27ae60;
        }

        .project-totals {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 30px 0;
        }

        .project-totals h3 {
            font-size: 24px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .grand-total {
            font-size: 48px;
            font-weight: bold;
            color: #00B04F;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .total-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .total-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .total-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .total-value {
            font-size: 20px;
            font-weight: bold;
        }

        .actions-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .action-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .action-card:hover {
            border-color: #00B04F;
            box-shadow: 0 4px 15px rgba(0, 176, 79, 0.1);
        }

        .action-icon {
            font-size: 36px;
            margin-bottom: 15px;
        }

        .action-title {
            font-size: 16px;
            font-weight: bold;
            color: #00B04F;
            margin-bottom: 10px;
        }

        .action-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .action-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00B04F 0%, #009944 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 176, 79, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #00B04F;
            border: 2px solid #00B04F;
        }

        .btn-secondary:hover {
            background: #00B04F;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            z-index: 1000;
        }

        .connection-status.online {
            background: #4caf50;
            color: white;
        }

        .connection-status.offline {
            background: #ff9800;
            color: white;
        }

        @media (max-width: 1200px) {
            .project-header {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .section-breakdown {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .total-breakdown {
                grid-template-columns: 1fr;
            }
            
            .grand-total {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        üü¢ Online
    </div>

    <div class="container">
        <div class="header">
            <div class="logo-section">
                <div class="company-logo">Current Development Limited</div>
                <div style="border-left: 2px solid rgba(255,255,255,0.3); height: 40px;"></div>
                <div>
                    <div class="logo">ZEUS</div>
                    <div class="subtitle">Project Collection Summary</div>
                </div>
            </div>
            <div class="status-indicator" id="projectStatus">
                Ready for Quote
            </div>
        </div>

        <div class="content">
            <!-- Project Header -->
            <div class="project-header">
                <div class="project-info">
                    <div class="project-label">Customer</div>
                    <div class="project-value" id="customerName">Loading...</div>
                </div>
                <div class="project-info">
                    <div class="project-label">Project Type</div>
                    <div class="project-value" id="projectType">Loading...</div>
                </div>
                <div class="project-info">
                    <div class="project-label">Quote Date</div>
                    <div class="project-value" id="quoteDate">[Current Date]</div>
                </div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-item">
                    <span style="color: #e74c3c; font-size: 20px;">‚ñ†</span>
                    <span>Total Costs</span>
                </div>
                <div class="legend-item">
                    <span style="color: #3498db; font-size: 20px;">‚ñ†</span>
                    <span>Profit & Margins</span>
                </div>
                <div class="legend-item">
                    <span style="color: #27ae60; font-size: 20px;">‚ñ†</span>
                    <span>Sale Prices</span>
                </div>
            </div>

            <!-- Section Breakdown -->
            <div class="section-breakdown">
                <!-- Equipment -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-title">üîß Equipment</div>
                        <button class="edit-btn" onclick="editSection('equipment')">Edit</button>
                    </div>
                    <div class="section-body">
                        <div class="cost-breakdown">
                            <div class="cost-row cost">
                                <span>Equipment Cost:</span>
                                <span id="equipmentCost">¬£0.00</span>
                            </div>
                            <div class="cost-row profit">
                                <span>Manufacturer Discount:</span>
                                <span id="equipmentDiscount">¬£0.00</span>
                            </div>
                            <div class="cost-row sale">
                                <span>Your Equipment Price:</span>
                                <span id="equipmentSale">¬£0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Materials -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-title">üì¶ Materials</div>
                        <button class="edit-btn" onclick="editSection('materials')">Edit</button>
                    </div>
                    <div class="section-body">
                        <div class="cost-breakdown">
                            <div class="cost-row cost">
                                <span>Materials Cost:</span>
                                <span id="materialsCost">¬£0.00</span>
                            </div>
                            <div class="cost-row profit">
                                <span>Materials Profit:</span>
                                <span id="materialsProfit">¬£0.00</span>
                            </div>
                            <div class="cost-row sale">
                                <span>Materials Sale Price:</span>
                                <span id="materialsSale">¬£0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Labour -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-title">üë∑ Labour</div>
                        <button class="edit-btn" onclick="editSection('labour')">Edit</button>
                    </div>
                    <div class="section-body">
                        <div class="cost-breakdown">
                            <div class="cost-row cost">
                                <span>Labour Cost:</span>
                                <span id="labourCost">¬£0.00</span>
                            </div>
                            <div class="cost-row profit">
                                <span>Labour Profit:</span>
                                <span id="labourProfit">¬£0.00</span>
                            </div>
                            <div class="cost-row sale">
                                <span>Labour Charge Out:</span>
                                <span id="labourSale">¬£0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hire & Preliminaries -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-title">üöß Hire & Preliminaries</div>
                        <button class="edit-btn" onclick="editSection('hire')">Edit</button>
                    </div>
                    <div class="section-body">
                        <div class="cost-breakdown">
                            <div class="cost-row cost">
                                <span>Hire & Prelims Cost:</span>
                                <span id="hireCost">¬£0.00</span>
                            </div>
                            <div class="cost-row profit">
                                <span>Hire & Prelims Profit:</span>
                                <span id="hireProfit">¬£0.00</span>
                            </div>
                            <div class="cost-row sale">
                                <span>Hire & Prelims Sale:</span>
                                <span id="hireSale">¬£0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Summary -->
            <div class="summary-section">
                <div class="summary-title">üìä Project Summary & Controls</div>
                
                <div class="summary-grid">
                    <div class="summary-breakdown">
                        <h4>Cost Breakdown</h4>
                        <div class="summary-item">
                            <span>Equipment:</span>
                            <span class="cost-value" id="summaryEquipmentCost">¬£0.00</span>
                        </div>
                        <div class="summary-item">
                            <span>Materials:</span>
                            <span class="cost-value" id="summaryMaterialsCost">¬£0.00</span>
                        </div>
                        <div class="summary-item">
                            <span>Labour:</span>
                            <span class="cost-value" id="summaryLabourCost">¬£0.00</span>
                        </div>
                        <div class="summary-item">
                            <span>Hire & Preliminaries:</span>
                            <span class="cost-value" id="summaryHireCost">¬£0.00</span>
                        </div>
                        <div class="summary-item">
                            <span>Total Project Cost:</span>
                            <span class="cost-value" id="totalProjectCost">¬£0.00</span>
                        </div>
                    </div>

                    <div class="controls-section">
                        <h4>üí∞ Final Pricing Controls</h4>
                        
                        <div class="control-group">
                            <label class="control-label">Overall Gross Profit %:</label>
                            <input type="number" class="control-input percentage" id="grossProfitPercent" 
                                   value="35" min="0" max="100" step="0.1" onchange="updateGrossProfit()">
                            <span style="color: #3498db; font-weight: bold; margin-left: 5px;">%</span>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Override Final Sale Price:</label>
                            <span style="color: #27ae60; font-weight: bold; margin-right: 5px;">¬£</span>
                            <input type="number" class="control-input currency" id="finalSalePrice" 
                                   step="0.01" onchange="updateFinalPrice()">
                        </div>

                        <div class="control-group">
                            <label class="control-label">Calculated Margin:</label>
                            <span style="color: #3498db; font-weight: bold; font-size: 18px;" id="calculatedMargin">35.0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Totals -->
            <div class="project-totals">
                <h3>Final Project Quote</h3>
                <div class="grand-total" id="grandTotal">¬£0.00</div>
                
                <div class="total-breakdown">
                    <div class="total-item">
                        <div class="total-label">Total Cost</div>
                        <div class="total-value cost-value" id="finalTotalCost">¬£0.00</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Total Profit</div>
                        <div class="total-value profit-value" id="finalTotalProfit">¬£0.00</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Gross Margin</div>
                        <div class="total-value profit-value" id="finalGrossMargin">35.0%</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions-section">
                <div class="action-card">
                    <div class="action-icon">üìã</div>
                    <div class="action-title">Generate Quote PDF</div>
                    <div class="action-description">Create professional quote document for client</div>
                    <button class="action-btn btn-primary" onclick="generateQuotePDF()">Generate PDF</button>
                </div>

                <div class="action-card">
                    <div class="action-icon">üì¶</div>
                    <div class="action-title">Publish BOM</div>
                    <div class="action-description">Send Bill of Materials to suppliers for ordering</div>
                    <button class="action-btn btn-primary" onclick="publishBOM()">Publish BOM</button>
                </div>

                <div class="action-card">
                    <div class="action-icon">üíæ</div>
                    <div class="action-title">Save Project</div>
                    <div class="action-description">Save project locally and to cloud storage</div>
                    <button class="action-btn btn-secondary" onclick="saveProject()">Save Project</button>
                </div>

                <div class="action-card">
                    <div class="action-icon">üì§</div>
                    <div class="action-title">Export Data</div>
                    <div class="action-description">Export project data for external systems</div>
                    <button class="action-btn btn-secondary" onclick="exportData()">Export Data</button>
                </div>

                <div class="action-card">
                    <div class="action-icon">üîÑ</div>
                    <div class="action-title">Duplicate Project</div>
                    <div class="action-description">Create copy for similar quotes</div>
                    <button class="action-btn btn-warning" onclick="duplicateProject()">Duplicate</button>
                </div>

                <div class="action-card">
                    <div class="action-icon">üóëÔ∏è</div>
                    <div class="action-title">Start Over</div>
                    <div class="action-description">Clear all data and start new project</div>
                    <button class="action-btn btn-warning" onclick="startOver()">Start Over</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let projectData = {};
        let isOnline = navigator.onLine;

        // Load and display project data
        function loadProjectData() {
            const data = localStorage.getItem('hvacProjectData');
            if (data) {
                projectData = JSON.parse(data);
                displayProjectHeader();
                calculateAndDisplayTotals();
            } else {
                // Demo data for display
                loadDemoData();
            }
        }

        function loadDemoData() {
            projectData = {
                customerName: 'ABC Commercial Ltd',
                capacity: '3.5',
                indoorUnitType: 'wall-mounted',
                jobEnvironment: 'commercial',
                selectedEquipment: {
                    model: 'FTXS35K / RXS35L',
                    listPrice: 1450,
                    yourPrice: 1131,
                    discount: 22
                },
                // Demo totals
                equipmentCost: 1450,
                equipmentDiscount: 319,
                equipmentSale: 1131,
                materialsCost: 850,
                materialsProfit: 298,
                materialsSale: 1148,
                labourCost: 720,
                labourProfit: 252,
                labourSale: 972,
                hireCost: 340,
                hireProfit: 119,
                hireSale: 459
            };
            displayProjectHeader();
            calculateAndDisplayTotals();
        }

        function displayProjectHeader() {
            document.getElementById('customerName').textContent = projectData.customerName || 'Demo Customer';
            document.getElementById('projectType').textContent = `${projectData.capacity || '3.5'}kW AC Installation`;
            document.getElementById('quoteDate').textContent = new Date().toLocaleDateString('en-GB');
        }

        function calculateAndDisplayTotals() {
            // Get individual section totals
            const equipmentCost = projectData.equipmentCost || 1450;
            const equipmentDiscount = projectData.equipmentDiscount || 319;
            const equipmentSale = projectData.equipmentSale || 1131;

            const materialsCost = projectData.materialsCost || 850;
            const materialsProfit = projectData.materialsProfit || 298;
            const materialsSale = projectData.materialsSale || 1148;

            const labourCost = projectData.labourCost || 720;
            const labourProfit = projectData.labourProfit || 252;
            const labourSale = projectData.labourSale || 972;

            const hireCost = projectData.hireCost || 340;
            const hireProfit = projectData.hireProfit || 119;
            const hireSale = projectData.hireSale || 459;

            // Display section breakdowns
            document.getElementById('equipmentCost').textContent = `¬£${equipmentCost.toLocaleString()}`;
            document.getElementById('equipmentDiscount').textContent = `¬£${equipmentDiscount.toLocaleString()}`;
            document.getElementById('equipmentSale').textContent = `¬£${equipmentSale.toLocaleString()}`;

            document.getElementById('materialsCost').textContent = `¬£${materialsCost.toLocaleString()}`;
            document.getElementById('materialsProfit').textContent = `¬£${materialsProfit.toLocaleString()}`;
            document.getElementById('materialsSale').textContent = `¬£${materialsSale.toLocaleString()}`;

            document.getElementById('labourCost').textContent = `¬£${labourCost.toLocaleString()}`;
            document.getElementById('labourProfit').textContent = `¬£${labourProfit.toLocaleString()}`;
            document.getElementById('labourSale').textContent = `¬£${labourSale.toLocaleString()}`;

            document.getElementById('hireCost').textContent = `¬£${hireCost.toLocaleString()}`;
            document.getElementById('hireProfit').textContent = `¬£${hireProfit.toLocaleString()}`;
            document.getElementById('hireSale').textContent = `¬£${hireSale.toLocaleString()}`;

            // Calculate project totals
            const totalCost = equipmentSale + materialsCost + labourCost + hireCost;
            const totalSale = equipmentSale + materialsSale + labourSale + hireSale;
            const totalProfit = totalSale - totalCost;
            const grossMargin = totalCost > 0 ? (totalProfit / totalSale * 100) : 0;

            // Update summary
            document.getElementById('summaryEquipmentCost').textContent = `¬£${equipmentSale.toLocaleString()}`;
            document.getElementById('summaryMaterialsCost').textContent = `¬£${materialsCost.toLocaleString()}`;
            document.getElementById('summaryLabourCost').textContent = `¬£${labourCost.toLocaleString()}`;
            document.getElementById('summaryHireCost').textContent = `¬£${hireCost.toLocaleString()}`;
            document.getElementById('totalProjectCost').textContent = `¬£${totalCost.toLocaleString()}`;

            // Update controls
            document.getElementById('finalSalePrice').value = totalSale.toFixed(2);

            // Update final totals
            updateFinalTotals(totalCost, totalProfit, totalSale, grossMargin);
        }

        function updateFinalTotals(cost, profit, sale, margin) {
            document.getElementById('grandTotal').textContent = `¬£${sale.toLocaleString()}`;
            document.getElementById('finalTotalCost').textContent = `¬£${cost.toLocaleString()}`;
            document.getElementById('finalTotalProfit').textContent = `¬£${profit.toLocaleString()}`;
            document.getElementById('finalGrossMargin').textContent = `${margin.toFixed(1)}%`;
            document.getElementById('calculatedMargin').textContent = `${margin.toFixed(1)}%`;
        }

        function updateGrossProfit() {
            const newMargin = parseFloat(document.getElementById('grossProfitPercent').value) || 35;
            const totalCost = parseFloat(document.getElementById('totalProjectCost').textContent.replace('¬£', '').replace(',', '')) || 0;
            
            const newSalePrice = totalCost / (1 - newMargin / 100);
            const newProfit = newSalePrice - totalCost;

            document.getElementById('finalSalePrice').value = newSalePrice.toFixed(2);
            updateFinalTotals(totalCost, newProfit, newSalePrice, newMargin);
        }

        function updateFinalPrice() {
            const newSalePrice = parseFloat(document.getElementById('finalSalePrice').value) || 0;
            const totalCost = parseFloat(document.getElementById('totalProjectCost').textContent.replace('¬£', '').replace(',', '')) || 0;
            
            const newProfit = newSalePrice - totalCost;
            const newMargin = newSalePrice > 0 ? (newProfit / newSalePrice * 100) : 0;

            document.getElementById('grossProfitPercent').value = newMargin.toFixed(1);
            updateFinalTotals(totalCost, newProfit, newSalePrice, newMargin);
        }

        // Navigation functions
        function editSection(section) {
            const sectionMap = {
                'equipment': 'Going to Equipment Selection page...',
                'materials': 'Going to Materials Selection page...',
                'labour': 'Going to Labour Allocation page...',
                'hire': 'Going to Hire & Preliminaries page...'
            };
            
            alert(sectionMap[section] || 'Navigating to section...');
            // In real app, this would navigate to the specific page
        }

        // Action functions
        function generateQuotePDF() {
            updateConnectionStatus();
            if (isOnline) {
                alert('Generating professional PDF quote...\n\nThis would create a client-ready quote document with your ZEUS branding.');
            } else {
                alert('PDF generation available offline!\n\nCreating local PDF with current project data.');
            }
        }

        function publishBOM() {
            updateConnectionStatus();
            const equipmentModel = projectData.selectedEquipment?.model || 'FTXS35K / RXS35L';
            
            if (isOnline) {
                alert(`Publishing BOM to suppliers...\n\nEquipment: ${equipmentModel}\nMaterials: Pipes, insulation, containment\nHire: Access equipment\n\nEmails sent to HRP, Mr Plant Hire, and equipment suppliers.`);
            } else {
                alert('Offline BOM created!\n\nBOM saved locally and will sync when online. You can print or export for manual ordering.');
            }
        }

        function saveProject() {
            const projectName = `${projectData.customerName || 'Demo'}_${document.getElementById('quoteDate').textContent}`;
            localStorage.setItem(`zeus_project_${Date.now()}`, JSON.stringify(projectData));
            
            if (isOnline) {
                alert(`Project "${projectName}" saved locally and to cloud storage.`);
            } else {
                alert(`Project "${projectName}" saved locally.\n\nWill sync to cloud when connection restored.`);
            }
        }

        function exportData() {
            const exportData = {
                ...projectData,
                quoteDate: document.getElementById('quoteDate').textContent,
                finalSalePrice: document.getElementById('finalSalePrice').value,
                grossMargin: document.getElementById('grossProfitPercent').value
            };

            // Create downloadable JSON file
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `zeus_project_${projectData.customerName || 'export'}.json`;
            link.click();

            alert('Project data exported successfully!\n\nJSON file downloaded for integration with external systems.');
        }

        function duplicateProject() {
            const duplicate = {
                ...projectData,
                customerName: `Copy of ${projectData.customerName || 'Demo Customer'}`,
                quoteDate: new Date().toLocaleDateString('en-GB')
            };
            
            localStorage.setItem(`zeus_project_copy_${Date.now()}`, JSON.stringify(duplicate));
            alert('Project duplicated successfully!\n\nYou can now modify the copy for a similar quote.');
        }

        function startOver() {
            if (confirm('Are you sure you want to clear all project data and start over?\n\nThis action cannot be undone.')) {
                localStorage.removeItem('hvacProjectData');
                localStorage.removeItem('hvacProjectDataDraft');
                alert('Project data cleared.\n\nReady to start a new quote.');
                // In real app, this would navigate back to page 1
            }
        }

        // Connection status monitoring
        function updateConnectionStatus() {
            isOnline = navigator.onLine;
            const statusElement = document.getElementById('connectionStatus');
            
            if (isOnline) {
                statusElement.textContent = 'üü¢ Online';
                statusElement.className = 'connection-status online';
            } else {
                statusElement.textContent = 'üî¥ Offline';
                statusElement.className = 'connection-status offline';
            }
        }

        // Event listeners
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Initialize
        window.addEventListener('load', function() {
            loadProjectData();
            updateConnectionStatus();
        });
    </script>
</body>
</html>
